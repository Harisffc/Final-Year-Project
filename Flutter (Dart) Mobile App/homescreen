import 'package:flutter/foundation.dart'; // For kIsWeb
import 'package:flutter/material.dart';
import 'package:camera/camera.dart';
import 'package:image_picker/image_picker.dart';
import 'dart:typed_data';
import 'dart:io' show File; // Only used on mobile

import 'package:provider/provider.dart';

// PointsProvider to manage user points
class PointsProvider extends ChangeNotifier {
  int _totalPoints = 0;

  int get totalPoints => _totalPoints;

  void addPoints(int points) {
    _totalPoints += points;
    notifyListeners();
  }
}

// HomeScreen displaying tasks and taking photos
class HomeScreen extends StatelessWidget {
  final List<CameraDescription> cameras;

  HomeScreen({Key? key, required this.cameras}) : super(key: key);

  final List<Map<String, dynamic>> tasks = [
    {'title': 'Donate Food', 'points': 50, 'taskType': 'food'},
    {'title': 'Reusable Bag', 'points': 30, 'taskType': 'bags'},
    {'title': 'Eco-Friendly Travel', 'points': 40, 'taskType': 'transport'},
    {'title': 'Save Water', 'points': 35, 'taskType': 'water'},
    {'title': 'Save Energy', 'points': 45, 'taskType': 'energy'},
  ];

  Future<void> _takePhoto(BuildContext context, String taskType, int points) async {
    final picker = ImagePicker();
    final image = await picker.pickImage(source: ImageSource.camera);

    if (image != null) {
      _askQuestion(context, taskType, points, image);
    }
  }

  void _askQuestion(BuildContext context, String taskType, int points, XFile image) async {
    final controller = TextEditingController();
    String question = '';

    switch (taskType) {
      case 'food':
        question = 'Almost how much food have you donated (kg)?';
        break;
      case 'bags':
        question = 'Almost how much plastic have you avoided (bags)?';
        break;
      case 'transport':
        question = 'Almost how much CO2 have you reduced (kg)?';
        break;
      case 'water':
        question = 'Almost how much water have you saved (liters)?';
        break;
      case 'energy':
        question = 'Almost how much energy have you saved (kWh)?';
        break;
    }

    Widget imageWidget;
    if (kIsWeb) {
      Uint8List imageBytes = await image.readAsBytes();
      imageWidget = Image.memory(imageBytes);
    } else {
      imageWidget = Image.file(File(image.path));
    }

    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('Task Completed!'),
        content: SingleChildScrollView(
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              imageWidget,
              const SizedBox(height: 12),
              Text(question, style: const TextStyle(color: Colors.black)),
              const SizedBox(height: 8),
              TextField(
                controller: controller,
                keyboardType: TextInputType.number,
                decoration: const InputDecoration(hintText: 'Enter amount'),
              ),
            ],
          ),
        ),
        actions: [
          TextButton(
            onPressed: () {
              if (controller.text.isNotEmpty) {
                Provider.of<PointsProvider>(context, listen: false).addPoints(points);
                Navigator.pop(context);
              } else {
                ScaffoldMessenger.of(context).showSnackBar(
                  const SnackBar(content: Text('Please enter a valid amount.')),
                );
              }
            },
            child: const Text('Submit'),
          ),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      appBar: AppBar(
        title: const Text('Eco Tasks'),
        backgroundColor: Colors.teal[700],
      ),
      body: ListView.builder(
        itemCount: tasks.length,
        itemBuilder: (context, index) {
          var task = tasks[index];
          return TaskCard(
            title: task['title'],
            points: task['points'],
            taskType: task['taskType'],
            onTakePhoto: () => _takePhoto(context, task['taskType'], task['points']),
          );
        },
      ),
    );
  }
}

// TaskCard widget displaying each task
class TaskCard extends StatelessWidget {
  final String title;
  final int points;
  final String taskType;
  final VoidCallback onTakePhoto;

  const TaskCard({
    Key? key,
    required this.title,
    required this.points,
    required this.taskType,
    required this.onTakePhoto,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Card(
      margin: const EdgeInsets.symmetric(vertical: 10, horizontal: 15),
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
 
